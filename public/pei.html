<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>BRYNIX PEI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f4f4;
    }
    #chat-container {
      max-width: 600px;
      margin: 40px auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    #chat {
      padding: 20px;
      height: 400px;
      overflow-y: auto;
      border-bottom: 1px solid #ccc;
    }
    #chat p {
      margin: 10px 0;
    }
    #form {
      display: flex;
      padding: 10px;
      gap: 10px;
    }
    #mensagem {
      flex: 1;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      background: #0051ff;
      color: white;
      cursor: pointer;
    }
    #extra-buttons {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-top: 1px solid #eee;
      background: #fafafa;
    }
    #extra-buttons button {
      background: #555;
    }
    #extra-buttons button:hover {
      background: #333;
    }
  </style>
</head>
<body>

<div id="chat-container">
  <div id="chat"></div>

  <div id="form">
    <input type="text" id="mensagem" placeholder="Digite sua mensagem..." autofocus />
    <button id="enviar">Enviar</button>
  </div>

  <div id="extra-buttons">
    <button onclick="finalizarConversa()">Finalizar Conversa</button>
    <button onclick="enviarEmail()">Enviar por E-mail</button>
  </div>
</div>

<script>
  const chat = document.getElementById('chat');
  const mensagemInput = document.getElementById('mensagem');
  const enviarBtn = document.getElementById('enviar');
  let sessao = {};

  // Geração e persistência do sessionId no navegador
  let sessionId = localStorage.getItem("pei_session_id");
  if (!sessionId) {
    sessionId = "sess_" + Date.now() + "_" + Math.random().toString(36).substring(2, 8);
    localStorage.setItem("pei_session_id", sessionId);
  }

  function adicionarMensagem(mensagem, autor = 'usuario') {
    const p = document.createElement('p');
    p.innerHTML = autor === 'usuario' ? `<strong>Você:</strong> ${mensagem}` : `<strong>BRYNIX:</strong> ${mensagem}`;
    chat.appendChild(p);
    chat.scrollTop = chat.scrollHeight;
  }

  function enviarMensagem() {
    const mensagem = mensagemInput.value.trim();
    if (!mensagem) return;
    adicionarMensagem(mensagem, 'usuario');
    mensagemInput.value = '';

    fetch('/pei/ia', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mensagem, sessao, sessionId })
    })
    .then(res => res.json())
    .then(data => {
      adicionarMensagem(data.resposta || '[resposta vazia]', 'ia');
      if (data.sessao) {
        sessao = data.sessao;
        sessao.sessionId = sessionId; // mantém sessionId no objeto para envio futuro
      }
    })
    .catch(err => {
      adicionarMensagem('[Erro ao comunicar com a IA]', 'ia');
      console.error(err);
    });
  }

  mensagemInput.addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      enviarMensagem();
    }
  });

  enviarBtn.addEventListener('click', enviarMensagem);

  function finalizarConversa() {
    adicionarMensagem('Obrigado pela conversa! A BRYNIX entrará em contato em breve.', 'ia');
    mensagemInput.disabled = true;
    enviarBtn.disabled = true;

    const dados = {
      timestamp: new Date().toLocaleString("pt-BR"),
      origem: 'Chat PEI',
      nome: sessao?.coletado?.nome || '',
      email: sessao?.coletado?.email || '',
      whatsapp: sessao?.coletado?.contato || '',
      empresa: sessao?.coletado?.empresa || '',
      porte: sessao?.coletado?.porte || '',
      desafio: sessao?.coletado?.desafio || '',
      tipo_interacao: 'chat_finalizado',
      classificacao: sessao?.coletado?.classificacao || 'morno',
      sessionId: sessao?.sessionId || sessionId,
      utm_source: '',
      utm_medium: '',
      utm_campaign: '',
      request_id: '',
      ip_hash: ''
    };

    fetch('/pei/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dados)
    })
    .then(() => {
      console.log('✅ Lead salvo ao finalizar conversa:', dados);
    })
    .catch(err => {
      console.error('❌ Erro ao salvar lead no final da conversa:', err);
    });
  }

  function enviarEmail() {
    const conteudo = Array.from(chat.querySelectorAll('p')).map(p => p.textContent).join('\n');
    const email = prompt("Digite seu e-mail para receber a conversa:");
    if (email) {
      fetch('/pei/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nome: sessao?.coletado?.nome || '',
          email,
          whatsapp: sessao?.coletado?.contato || '',
          empresa: sessao?.coletado?.empresa || '',
          porte: sessao?.coletado?.porte || '',
          desafio: sessao?.coletado?.desafio || '',
          classificacao: sessao?.coletado?.classificacao || 'morno',
          tipo_interacao: 'email',
          origem: 'Chat PEI',
          sessionId: sessao?.sessionId || sessionId,
          timestamp: new Date().toLocaleString("pt-BR"),
        })
      }).then(() => {
        alert("Conversa enviada para seu e-mail (registro simulado)!");
      });
    }
  }
</script>

</body>
</html>
